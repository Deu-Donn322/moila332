# -*- coding: utf-8 -*-
import os
import re
import json
import time
import random
import sqlite3
from datetime import datetime
from typing import List, Dict, Any, Callable, Tuple, Optional

import telebot
from telebot.types import InlineKeyboardMarkup, InlineKeyboardButton, ReplyKeyboardMarkup, KeyboardButton

# ------------------------------------------------------------
# Utilities
# ------------------------------------------------------------

def escape_md(text: str) -> str:
    """
    Escapes Markdown-sensitive characters to prevent Telegram formatting issues.
    """
    if not text:
        return text
    replacements = {
        "*": r"\*",
        "_": r"\_",
        "`": r"\`",
        "[": r"\[",
        "]": r"\]",
    }
    for k, v in replacements.items():
        text = text.replace(k, v)
    return text

def now_str() -> str:
    """
    Returns the current timestamp as a formatted string.
    """
    return datetime.now().strftime("%Y-%m-%d %H:%M:%S")

# ------------------------------------------------------------
# Non-Repeating Selector (User-based, via SQLite)
# ------------------------------------------------------------

class NonRepeatingSelector:
    def __init__(self, db: sqlite3.Connection):
        """
        Initializes the selector with a SQLite database connection.
        """
        self.db = db
        self._ensure_schema()

    def _ensure_schema(self) -> None:
        """
        Creates the selections table and index if they don't exist.
        """
        try:
            cur = self.db.cursor()
            cur.execute("""
                CREATE TABLE IF NOT EXISTS selections (
                    user_id INTEGER NOT NULL,
                    category TEXT NOT NULL,
                    item_key TEXT NOT NULL,
                    used_at TEXT NOT NULL
                )
            """)
            cur.execute("CREATE INDEX IF NOT EXISTS idx_selections ON selections(user_id, category, used_at)")
            self.db.commit()
        except sqlite3.Error as e:
            print(f"Database schema creation error: {e}")

    def record(self, user_id: int, category: str, item_key: str) -> None:
        """
        Records a selected item for a user and category.
        """
        try:
            cur = self.db.cursor()
            cur.execute("INSERT INTO selections (user_id, category, item_key, used_at) VALUES (?, ?, ?, ?)",
                        (user_id, category, item_key, now_str()))
            self.db.commit()
        except sqlite3.Error as e:
            print(f"Error recording selection: {e}")

    def recent_keys(self, user_id: int, category: str, limit_count: int) -> List[str]:
        """
        Retrieves the most recent item keys for a user and category.
        """
        try:
            cur = self.db.cursor()
            cur.execute("""
                SELECT item_key FROM selections
                WHERE user_id=? AND category=?
                ORDER BY used_at DESC
                LIMIT ?
            """, (user_id, category, limit_count))
            rows = cur.fetchall()
            return [r[0] for r in rows]
        except sqlite3.Error as e:
            print(f"Error fetching recent keys: {e}")
            return []

    def select_one(self, user_id: int, category: str, items: List[Any], key_fn: Callable[[Any], str], recent_window: Optional[int] = None) -> Any:
        """
        Selects one item, avoiding the last 'recent_window' items used by the user.
        Falls back to full list if no non-recent items are available.
        """
        if not items:
            raise ValueError("select_one: items list is empty")
        if recent_window is None:
            recent_window = max(1, len(items) - 1)

        recent = set(self.recent_keys(user_id, category, recent_window))
        candidates = [x for x in items if key_fn(x) not in recent]

        if not candidates:
            candidates = items[:]

        choice = random.choice(candidates)
        self.record(user_id, category, key_fn(choice))
        return choice

    def select_many(self, user_id: int, category: str, items: List[Any], key_fn: Callable[[Any], str], k: int, recent_window: Optional[int] = None) -> List[Any]:
        """
        Selects k items, avoiding recent items where possible.
        """
        if k <= 0 or not items:
            return []
        if k >= len(items):
            randomized = items[:]
            random.shuffle(randomized)
            for it in randomized:
                self.record(user_id, category, key_fn(it))
            return randomized

        selected: List[Any] = []
        seen_keys = set()
        for _ in range(k):
            remaining = [x for x in items if key_fn(x) not in seen_keys]
            if not remaining:
                break
            choice = self.select_one(user_id, category, remaining, key_fn, recent_window=recent_window)
            sk = key_fn(choice)
            if sk in seen_keys:
                continue
            seen_keys.add(sk)
            selected.append(choice)
        return selected

# ------------------------------------------------------------
# Data (Extensible) - Expanded for broader coverage
# ------------------------------------------------------------

SYMBOLS: Dict[str, Dict[str, Any]] = {
    "eau": {
        "synonymes": ["rivi√®re", "mer", "oc√©an", "pluie", "torrent", "lacs", "√©tang", "inondation"],
        "interpretations": [
            {
                "interpretation": "L'eau symbolise souvent la purification, le renouveau spirituel, ou la vie en Christ. J√©sus a promis l'eau vive √† ceux qui cherchent Sa pr√©sence.",
                "verset": "Jean 7:37-38",
                "priere": "Seigneur J√©sus, purifie mon c≈ìur et donne-moi de boire √† ta source in√©puisable. Amen."
            },
            {
                "interpretation": "Une eau agit√©e ou trouble peut refl√©ter des perturbations √©motionnelles ou spirituelles, mais Christ apporte la paix sur les temp√™tes.",
                "verset": "Marc 4:39",
                "priere": "J√©sus, parle √† mes temp√™tes int√©rieures et √©tablis ta paix durable. Amen."
            },
            {
                "interpretation": "Une eau claire √©voque la clart√© spirituelle, la v√©rit√© r√©v√©l√©e par la Parole de Dieu, et une invitation √† la foi pure.",
                "verset": "Psaume 119:105",
                "priere": "P√®re, √©claire mon chemin par ta Parole et rends mes pens√©es limpides. Amen."
            },
            {
                "interpretation": "L'eau en abondance peut symboliser une effusion de l'Esprit Saint, apportant b√©n√©diction et renouveau.",
                "verset": "√âz√©chiel 36:25-27",
                "priere": "Seigneur, r√©pands ton Esprit sur moi pour un renouveau profond. Amen."
            },
        ]
    },
    "voler": {
        "synonymes": ["s'envoler", "envol", "ailes", "planer", "ciel"],
        "interpretations": [
            {
                "interpretation": "Voler traduit une √©l√©vation spirituelle, une libert√© en Christ, ou une aspiration √† s'approcher de Dieu.",
                "verset": "√âsa√Øe 40:31",
                "priere": "Seigneur, √©l√®ve-moi au-dessus des fardeaux et renouvelle ma force. Amen."
            },
            {
                "interpretation": "Prendre de la hauteur peut refl√©ter un appel √† adopter la perspective divine sur les d√©fis de la vie.",
                "verset": "Colossiens 3:2",
                "priere": "P√®re, attache mon c≈ìur aux r√©alit√©s d'en haut et non √† celles d'en bas. Amen."
            },
            {
                "interpretation": "Voler peut aussi indiquer une d√©livrance des cha√Ænes terrestres, invitant √† la confiance en Dieu.",
                "verset": "Psaume 55:6-8",
                "priere": "Donne des ailes √† mon √¢me pour chercher ta paix. Amen."
            },
        ]
    },
    "maison": {
        "synonymes": ["foyer", "habitation", "demeure", "logis", "b√¢timent"],
        "interpretations": [
            {
                "interpretation": "La maison repr√©sente souvent le c≈ìur ou l'√¢me, un lieu o√π Dieu d√©sire habiter comme temple du Saint-Esprit.",
                "verset": "1 Corinthiens 6:19-20",
                "priere": "Saint-Esprit, sanctifie ma vie pour qu'elle te soit consacr√©e. Amen."
            },
            {
                "interpretation": "Une maison peut symboliser la stabilit√©, la famille, ou l'alliance avec Dieu, mais aussi un besoin de fondations solides.",
                "verset": "Josu√© 24:15",
                "priere": "Seigneur, que ma maison serve l'√âternel avec fid√©lit√©. Amen."
            },
            {
                "interpretation": "Une maison en d√©sordre peut refl√©ter un besoin de restauration int√©rieure ou de r√©conciliation.",
                "verset": "Matthieu 7:24-25",
                "priere": "P√®re, b√¢tis ma vie sur le roc de ta Parole. Amen."
            },
        ]
    },
    "serpent": {
        "synonymes": ["vip√®re", "reptile", "cobra"],
        "interpretations": [
            {
                "interpretation": "Le serpent peut symboliser la tentation ou une lutte spirituelle contre les forces du mal.",
                "verset": "1 Pierre 5:8-9",
                "priere": "Seigneur, affermis-moi afin que je r√©siste aux ruses du malin. Amen."
            },
            {
                "interpretation": "Il peut aussi repr√©senter la prudence et la sagesse dans un monde complexe.",
                "verset": "Matthieu 10:16",
                "priere": "Donne-moi sagesse et simplicit√© selon ton Esprit. Amen."
            },
            {
                "interpretation": "Un serpent vaincu peut symboliser la victoire en Christ sur le p√©ch√© et l'ennemi.",
                "verset": "Luc 10:19",
                "priere": "J√©sus, donne-moi l'autorit√© pour marcher dans ta victoire. Amen."
            },
        ]
    },
    "voiture": {
        "synonymes": ["auto", "v√©hicule", "conduire", "transport"],
        "interpretations": [
            {
                "interpretation": "La voiture refl√®te souvent le chemin de vie, le voyage spirituel, ou la direction que prend votre √¢me.",
                "verset": "Jean 14:6",
                "priere": "Guide mes pas et dirige ma route, Seigneur. Amen."
            },
            {
                "interpretation": "Conduire peut indiquer un besoin de contr√¥le ou un appel √† laisser Dieu guider votre vie.",
                "verset": "Proverbes 3:5-6",
                "priere": "Je m'appuie sur toi, dirige mes sentiers. Amen."
            },
            {
                "interpretation": "Une voiture en panne peut symboliser des obstacles sur votre chemin, n√©cessitant la pri√®re et la patience.",
                "verset": "Psaume 37:7",
                "priere": "Seigneur, enseigne-moi √† attendre ta d√©livrance. Amen."
            },
        ]
    },
    "argent": {
        "synonymes": ["richesse", "or", "finances", "billets", "monnaie"],
        "interpretations": [
            {
                "interpretation": "L'argent peut repr√©senter une tentation mat√©rielle, mais aussi la provision divine pour ceux qui font confiance √† Dieu.",
                "verset": "1 Timoth√©e 6:10",
                "priere": "D√©tache mon c≈ìur de l'avidit√© et apprends-moi la confiance. Amen."
            },
            {
                "interpretation": "Une gestion fid√®le des ressources mat√©rielles honore Dieu et refl√®te la foi.",
                "verset": "Luc 16:10-11",
                "priere": "Rends-moi fid√®le dans les petites choses comme dans les grandes. Amen."
            },
            {
                "interpretation": "L'abondance ou le manque d'argent peut refl√©ter un appel √† chercher d'abord le royaume de Dieu.",
                "verset": "Matthieu 6:33",
                "priere": "P√®re, que ton royaume soit ma priorit√©. Amen."
            },
        ]
    },
    "mariage": {
        "synonymes": ["noces", "√©poux", "√©pouse", "alliances", "union"],
        "interpretations": [
            {
                "interpretation": "Le mariage symbolise l'alliance spirituelle avec Christ, l'√âpoux de l'√âglise, ou une relation sacr√©e.",
                "verset": "√âsa√Øe 54:5",
                "priere": "Unis mon c≈ìur √† toi dans une alliance fid√®le. Amen."
            },
            {
                "interpretation": "Il peut refl√©ter l'unit√©, la fid√©lit√©, ou un engagement renouvel√© envers Dieu ou les autres.",
                "verset": "√âph√©siens 5:25-33",
                "priere": "Apprends-moi l'amour qui se donne et se sacrifie. Amen."
            },
            {
                "interpretation": "Un mariage troubl√© peut indiquer un besoin de r√©conciliation ou de restauration dans une relation.",
                "verset": "Colossiens 3:13-14",
                "priere": "Seigneur, aide-moi √† pardonner et √† aimer comme toi. Amen."
            },
        ]
    },
    "enfant": {
        "synonymes": ["b√©b√©", "fille", "gar√ßon", "petit", "nouveau-n√©"],
        "interpretations": [
            {
                "interpretation": "Un enfant symbolise la simplicit√© de la foi, l'innocence, ou un nouveau d√©part en Christ.",
                "verset": "Marc 10:14-15",
                "priere": "Donne-moi un c≈ìur simple et confiant. Amen."
            },
            {
                "interpretation": "Il peut repr√©senter une croissance spirituelle ou une nouvelle b√©n√©diction √† venir.",
                "verset": "1 Pierre 2:2-3",
                "priere": "Fais-moi cro√Ætre par la Parole vivante. Amen."
            },
            {
                "interpretation": "Un enfant en danger peut refl√©ter une vuln√©rabilit√© int√©rieure n√©cessitant la protection divine.",
                "verset": "Psaume 91:11",
                "priere": "Seigneur, envoie tes anges pour me garder. Amen."
            },
        ]
    },
    "animal": {
        "synonymes": ["b√™te", "chien", "chat", "cheval", "lion", "oiseau", "loup"],
        "interpretations": [
            {
                "interpretation": "Les animaux rappellent la providence de Dieu, qui veille sur toute sa cr√©ation.",
                "verset": "Matthieu 6:26",
                "priere": "Apprends-moi √† reposer dans ta providence. Amen."
            },
            {
                "interpretation": "Chaque animal peut symboliser une qualit√© (force, douceur, vigilance) ou une le√ßon spirituelle.",
                "verset": "Proverbes 30:24-28",
                "priere": "Inspire-moi par la sagesse de ta cr√©ation. Amen."
            },
            {
                "interpretation": "Un animal mena√ßant peut repr√©senter une lutte spirituelle ou un d√©fi √† surmonter par la foi.",
                "verset": "√âph√©siens 6:10-11",
                "priere": "Rev√™ts-moi de ton armure pour r√©sister. Amen."
            },
        ]
    },
    "chat": {
        "synonymes": ["chats", "f√©lin"],
        "interpretations": [
            {
                "interpretation": "Le chat symbolise souvent la vigilance, l'ind√©pendance, ou un appel √† discerner les influences subtiles.",
                "verset": "Matthieu 25:13",
                "priere": "Rends-moi vigilant et pr√™t. Amen."
            },
            {
                "interpretation": "Il peut aussi refl√©ter un √©quilibre entre solitude et besoin de communion avec Dieu ou les autres.",
                "verset": "Psaume 84:10",
                "priere": "Attire-moi dans ta pr√©sence et ta maison. Amen."
            },
        ]
    },
    "oiseau": {
        "synonymes": ["oiseaux", "hirondelle", "moineau", "aigle", "colombe"],
        "interpretations": [
            {
                "interpretation": "L'oiseau √©voque la libert√© spirituelle, l'√©l√©vation vers Dieu, ou la paix de l'Esprit.",
                "verset": "Proverbes 26:2",
                "priere": "Lib√®re-moi de toute oppression inutile. Amen."
            },
            {
                "interpretation": "S'envoler symbolise un d√©sir de transcender les √©preuves terrestres pour chercher Dieu.",
                "verset": "Psaume 55:6-8",
                "priere": "Donne des ailes √† mon √¢me pour te chercher. Amen."
            },
            {
                "interpretation": "Un oiseau bless√© peut refl√©ter une fragilit√© int√©rieure, n√©cessitant la gu√©rison divine.",
                "verset": "Psaume 147:3",
                "priere": "Seigneur, gu√©ris mes blessures profondes. Amen."
            },
        ]
    },
    "arbre": {
        "synonymes": ["arbres", "racines", "for√™t", "branches"],
        "interpretations": [
            {
                "interpretation": "L'arbre symbolise l'enracinement dans la foi et la f√©condit√© spirituelle par la Parole.",
                "verset": "Psaume 1:3",
                "priere": "Plante-moi pr√®s de l'eau vive de ta Parole. Amen."
            },
            {
                "interpretation": "Il repr√©sente aussi les saisons de la vie et la croissance dans la volont√© de Dieu.",
                "verset": "Eccl√©siaste 3:1-2",
                "priere": "Apprends-moi √† discerner les temps. Amen."
            },
            {
                "interpretation": "Un arbre sec peut indiquer un besoin de renouveau spirituel ou de reconnection avec Dieu.",
                "verset": "J√©r√©mie 17:7-8",
                "priere": "Seigneur, fais-moi prosp√©rer en toi, m√™me dans la s√©cheresse. Amen."
            },
        ]
    },
    "soleil": {
        "synonymes": ["lumi√®re", "rayon", "jour", "soleils"],
        "interpretations": [
            {
                "interpretation": "Le soleil repr√©sente la lumi√®re de Christ, dissipant les t√©n√®bres et apportant la v√©rit√©.",
                "verset": "Jean 8:12",
                "priere": "Lumi√®re du monde, √©claire mon chemin. Amen."
            },
            {
                "interpretation": "Il symbolise aussi la gu√©rison, la justice, et la pr√©sence r√©confortante de Dieu.",
                "verset": "Malachie 4:2",
                "priere": "Fais lever sur moi un soleil de justice. Amen."
            },
            {
                "interpretation": "Un soleil √©clatant peut refl√©ter la gloire de Dieu ou une r√©v√©lation divine.",
                "verset": "Psaume 84:11",
                "priere": "Seigneur, sois mon soleil et mon bouclier. Amen."
            },
        ]
    },
    "lune": {
        "synonymes": ["clair de lune", "nuit", "croissant", "lunes"],
        "interpretations": [
            {
                "interpretation": "La lune refl√®te la lumi√®re de Dieu, nous appelant √† √™tre des t√©moins de Christ.",
                "verset": "Matthieu 5:14-16",
                "priere": "Fais de moi un reflet fid√®le de ta lumi√®re. Amen."
            },
            {
                "interpretation": "Elle marque les saisons spirituelles et les cycles de renouvellement.",
                "verset": "Gen√®se 1:16-18",
                "priere": "Que tes temps r√©glent mes pas. Amen."
            },
            {
                "interpretation": "Une lune obscure peut symboliser une p√©riode de doute, n√©cessitant la foi pour avancer.",
                "verset": "Psaume 23:4",
                "priere": "Seigneur, guide-moi m√™me dans l'ombre. Amen."
            },
        ]
    },
    "mort": {
        "synonymes": ["d√©c√®s", "fun√©railles", "cimeti√®re", "mourir", "mourrir", "tombe"],
        "interpretations": [
            {
                "interpretation": "La mort dans un r√™ve peut symboliser la fin d'un cycle de vie, ouvrant la voie √† un renouveau spirituel en Christ.",
                "verset": "2 Corinthiens 5:17",
                "priere": "Fais de moi une nouvelle cr√©ature en Christ. Amen."
            },
            {
                "interpretation": "Elle invite souvent √† abandonner l'ancien pour rev√™tir l'homme nouveau, en se confiant √† Dieu.",
                "verset": "√âph√©siens 4:22-24",
                "priere": "Renouvelle mon √™tre int√©rieur par ton Esprit. Amen."
            },
            {
                "interpretation": "La mort peut refl√©ter une peur ou une transition majeure, mais Dieu promet la vie √©ternelle √† ceux qui croient.",
                "verset": "Jean 11:25-26",
                "priere": "J√©sus, tu es la r√©surrection et la vie; fortifie ma foi. Amen."
            },
            {
                "interpretation": "Elle peut aussi √™tre un appel au repentir ou √† une r√©√©valuation des priorit√©s spirituelles face √† la fragilit√© de la vie.",
                "verset": "Psaumes 118:17",
                "priere": "Je ne mourrai pas, je vivrai, et je raconterai les ≈ìuvres de l'√âternel. Amen."
            },
            {
                "interpretation": "Dans un contexte de peur, la mort symbolise parfois une lutte spirituelle, mais Dieu est plus fort que toute fin.",
                "verset": "1 Corinthiens 15:54-55",
                "priere": "Seigneur, o√π est ta victoire, √¥ mort ? Fortifie-moi par ton triomphe. Amen."
            },
        ]
    },
    "maladie": {
        "synonymes": ["cancer", "tumeur", "atteint", "malade", "affliction", "fi√®vre", "douleur"],
        "interpretations": [
            {
                "interpretation": "La maladie, comme le cancer, peut symboliser une lutte spirituelle ou une affliction qui ronge l'√¢me, appelant √† la gu√©rison par la foi.",
                "verset": "Psaumes 103:3",
                "priere": "Seigneur, gu√©ris toutes mes maladies et pardonne mes iniquit√©s. Amen."
            },
            {
                "interpretation": "Elle refl√®te parfois les cons√©quences d'un monde d√©chu, mais Dieu offre la r√©demption et la gu√©rison physique ou spirituelle.",
                "verset": "Jacques 5:14-15",
                "priere": "Seigneur, que la pri√®re de la foi sauve le malade et le rel√®ve. Amen."
            },
            {
                "interpretation": "Une maladie dans un r√™ve peut indiquer un fardeau √©motionnel ou spirituel, invitant √† chercher la paix en Christ.",
                "verset": "√âph√©siens 6:12",
                "priere": "P√®re, aide-moi dans cette lutte spirituelle contre les forces du mal. Amen."
            },
            {
                "interpretation": "Elle peut √™tre un appel √† se tourner vers Dieu pour la force et la gu√©rison face aux √©preuves.",
                "verset": "Exode 15:26",
                "priere": "√âternel, tu es mon gu√©risseur; √©coute mes cris et gu√©ris-moi. Amen."
            },
            {
                "interpretation": "Une maladie grave peut symboliser un besoin urgent de restauration et de confiance en la providence divine.",
                "verset": "Psaume 30:2-3",
                "priere": "Seigneur, tu m'as gu√©ri et soutenu; restaure-moi par ta gr√¢ce. Amen."
            },
        ]
    },
    "feu": {
        "synonymes": ["flamme", "incendie", "brasier", "br√ªler"],
        "interpretations": [
            {
                "interpretation": "Le feu symbolise la pr√©sence de Dieu, la purification, ou un jugement spirituel qui purifie l'√¢me.",
                "verset": "H√©breux 12:29",
                "priere": "Dieu de feu, purifie mon c≈ìur par ton Esprit. Amen."
            },
            {
                "interpretation": "Un feu destructeur peut refl√©ter une √©preuve ou une attaque spirituelle, mais Dieu prot√®ge ceux qui se confient en Lui.",
                "verset": "Daniel 3:25",
                "priere": "Seigneur, marche avec moi dans les flammes de l'√©preuve. Amen."
            },
            {
                "interpretation": "Le feu peut aussi repr√©senter le z√®le ou une passion renouvel√©e pour la mission de Dieu.",
                "verset": "Luc 12:49",
                "priere": "J√©sus, allume en moi un feu pour ta gloire. Amen."
            },
        ]
    },
    "ciel": {
        "synonymes": ["nuages", "√©toiles", "paradis", "firmament"],
        "interpretations": [
            {
                "interpretation": "Le ciel symbolise la pr√©sence divine, l'√©ternit√©, ou un appel √† lever les yeux vers Dieu.",
                "verset": "Psaume 19:1",
                "priere": "Seigneur, que tes cieux proclament ta gloire dans ma vie. Amen."
            },
            {
                "interpretation": "Un ciel clair peut refl√©ter l'espoir et la promesse de la vie √©ternelle en Christ.",
                "verset": "Jean 14:2-3",
                "priere": "J√©sus, pr√©pare-moi une place dans ta maison √©ternelle. Amen."
            },
            {
                "interpretation": "Un ciel orageux peut indiquer des troubles, mais aussi l'intervention imminente de Dieu.",
                "verset": "Psaume 18:13-14",
                "priere": "Seigneur, parle dans la temp√™te et guide-moi. Amen."
            },
        ]
    },
    "route": {
        "synonymes": ["chemin", "sentier", "voyage", "parcours"],
        "interpretations": [
            {
                "interpretation": "Une route symbolise le chemin de vie, o√π J√©sus est le guide ultime.",
                "verset": "Jean 14:6",
                "priere": "J√©sus, sois mon chemin, ma v√©rit√© et ma vie. Amen."
            },
            {
                "interpretation": "Une route difficile peut refl√©ter des d√©fis, mais Dieu promet de diriger vos pas.",
                "verset": "Proverbes 3:5-6",
                "priere": "Seigneur, aplanis mes sentiers selon ta volont√©. Amen."
            },
            {
                "interpretation": "Une route inconnue peut indiquer un appel √† la foi et √† l'abandon √† Dieu.",
                "verset": "H√©breux 11:8",
                "priere": "P√®re, guide-moi par la foi, m√™me dans l'inconnu. Amen."
            },
        ]
    },
    "sang": {
        "synonymes": ["sanglant", "h√©morragie", "plaie"],
        "interpretations": [
            {
                "interpretation": "Le sang symbolise souvent le sacrifice de Christ, la r√©demption, ou la vie spirituelle.",
                "verset": "H√©breux 9:14",
                "priere": "Seigneur, purifie-moi par le sang pr√©cieux de J√©sus. Amen."
            },
            {
                "interpretation": "Il peut aussi refl√©ter une blessure √©motionnelle ou spirituelle n√©cessitant la gu√©rison divine.",
                "verset": "Psaume 147:3",
                "priere": "Dieu, gu√©ris mes plaies par ta gr√¢ce. Amen."
            },
            {
                "interpretation": "Le sang peut repr√©senter une alliance ou un engagement sacr√© avec Dieu.",
                "verset": "Exode 24:8",
                "priere": "Seigneur, scelle mon c≈ìur dans ton alliance. Amen."
            },
        ]
    },
}

VERSETS_ENCOURAGEMENT: List[Dict[str, str]] = [
    {"verset": "J√©r√©mie 29:11", "texte": "Car je connais les projets que j'ai form√©s sur vous, dit l'√âternel, projets de paix et non de malheur, afin de vous donner un avenir et de l'esp√©rance.", "key": "Jer29:11"},
    {"verset": "Philippiens 4:13", "texte": "Je puis tout par celui qui me fortifie.", "key": "Phi4:13"},
    {"verset": "Psaume 23:1-3", "texte": "L'√âternel est mon berger: je ne manquerai de rien. Il me fait reposer dans de verts p√¢turages, Il me dirige pr√®s des eaux paisibles.", "key": "Ps23:1-3"},
    {"verset": "Romains 8:28", "texte": "Nous savons, du reste, que toutes choses concourent au bien de ceux qui aiment Dieu.", "key": "Rom8:28"},
    {"verset": "√âsa√Øe 41:10", "texte": "Ne crains rien, car je suis avec toi; Ne prom√®ne pas des regards inquiets, car je suis ton Dieu; Je te fortifie.", "key": "Isa41:10"},
    {"verset": "Psaume 27:1", "texte": "L'√âternel est ma lumi√®re et mon salut: De qui aurais-je crainte? L'√âternel est le soutien de ma vie: De qui aurais-je peur?", "key": "Ps27:1"},
    {"verset": "Psaume 34:5", "texte": "Quand on tourne vers lui les regards, on est rayonnant de joie, Et le visage ne se couvre pas de honte.", "key": "Ps34:5"},
    {"verset": "Jean 14:27", "texte": "Je vous laisse la paix, je vous donne ma paix. Je ne vous donne pas comme le monde donne. Que votre c≈ìur ne se trouble point.", "key": "Jn14:27"},
    {"verset": "Proverbes 3:5-6", "texte": "Confie-toi en l'√âternel de tout ton c≈ìur, Et ne t'appuie pas sur ta sagesse; Reconnais-le dans toutes tes voies, Et il aplanira tes sentiers.", "key": "Prov3:5-6"},
    {"verset": "Psaume 91:1-2", "texte": "Celui qui demeure sous l'abri du Tr√®s-Haut Repose √† l'ombre du Tout-Puissant. Je dis √† l'√âternel: Mon refuge et ma forteresse, Mon Dieu en qui je me confie!", "key": "Ps91:1-2"},
    {"verset": "Psaumes 103:2-3", "texte": "Que mon √¢me b√©nisse l'√âternel! Qu'elle n'oublie aucun de ses bienfaits! C'est lui qui pardonne toutes tes iniquit√©s, Qui gu√©rit toutes tes maladies.", "key": "Ps103:2-3"},
    {"verset": "Jean 11:25", "texte": "J√©sus lui dit: Je suis la r√©surrection et la vie. Celui qui croit en moi vivra, quand m√™me il serait mort.", "key": "Jn11:25"},
    {"verset": "Psaumes 118:17", "texte": "Je ne mourrai pas, je vivrai, Et je raconterai les ≈ìuvres de l'√âternel.", "key": "Ps118:17"},
    {"verset": "Psaume 30:2-3", "texte": "√âternel, mon Dieu! J'ai cri√© √† toi, et tu m'as gu√©ri. √âternel, tu as fait remonter mon √¢me du s√©jour des morts, Tu m'as fait revivre loin de ceux qui descendent dans la fosse.", "key": "Ps30:2-3"},
    {"verset": "√âsa√Øe 53:5", "texte": "Mais il √©tait bless√© pour nos p√©ch√©s, Bris√© pour nos iniquit√©s; Le ch√¢timent qui nous donne la paix est tomb√© sur lui, Et c'est par ses meurtrissures que nous sommes gu√©ris.", "key": "Isa53:5"},
]

PRIERE_PAR_EMOTION: Dict[str, List[str]] = {
    "peur": [
        "Seigneur J√©sus, tu dis: N'ayez pas peur, c'est moi. Verse ta paix dans mon c≈ìur et chasse toute crainte. Amen.",
        "P√®re, je me r√©fugie en toi; que ta pr√©sence dissipe mes peurs et m'entoure de ton amour. Amen.",
        "Dieu de paix, garde mes pens√©es en Christ et affermis-moi face √† l'incertitude. Amen.",
        "Seigneur, face √† la peur de la mort, rappelle-moi que tu es la r√©surrection et la vie. Amen.",
        "P√®re c√©leste, enveloppe-moi de ton courage et guide-moi dans l'ombre de la vall√©e. Amen.",
    ],
    "inquietude": [
        "Je d√©pose mes soucis √† tes pieds; apprends-moi la confiance jour apr√®s jour. Amen.",
        "Seigneur, d√©livre-moi de l'angoisse et donne-moi ta paix qui surpasse toute intelligence. Amen.",
        "P√®re fid√®le, je choisis de ne pas m'inqui√©ter, mais de prier avec foi. Amen.",
        "Dieu, calme mon c≈ìur inquiet et guide-moi vers tes promesses. Amen.",
    ],
    "tristesse": [
        "Tu es proche de ceux qui ont le c≈ìur bris√©; console-moi et rel√®ve-moi par ton amour. Amen.",
        "Esprit de Dieu, remplace mes cendres par une huile de joie et restaure mon √¢me. Amen.",
        "J√©sus, gu√©ris mon c≈ìur bris√© et renouvelle mon esp√©rance en toi. Amen.",
        "Seigneur, dans ma tristesse, sois ma joie et ma force. Amen.",
    ],
    "colere": [
        "Seigneur, rends-moi lent √† la col√®re et riche en bont√©, selon ton c≈ìur. Amen.",
        "J√©sus, r√®gne dans mon c≈ìur et chasse toute irritation par ta paix. Amen.",
        "P√®re, apprends-moi la douceur et la ma√Ætrise de soi par ton Esprit. Amen.",
    ],
    "doute": [
        "Augmente ma foi, Seigneur; je choisis de croire malgr√© l'incertitude. Amen.",
        "Dieu fid√®le, fortifie ma confiance en tes promesses √©ternelles. Amen.",
        "Saint-Esprit, √©claire mes pas quand la route est floue et confuse. Amen.",
    ],
    "espoir": [
        "Seigneur, ravive mon esp√©rance par ta Parole vivante et √©ternelle. Amen.",
        "P√®re, fais briller ton espoir dans mon c≈ìur comme une lumi√®re dans la nuit. Amen.",
        "J√©sus, ancre mon √¢me dans l'esp√©rance de ta r√©surrection. Amen.",
    ],
    "confusion": [
        "Seigneur, apporte la clart√© √† mon esprit et guide-moi par ta v√©rit√©. Amen.",
        "P√®re, dissipe ma confusion et r√©v√®le ta volont√© dans ce r√™ve. Amen.",
        "Esprit Saint, ordonne mes pens√©es selon ta sagesse divine. Amen.",
    ],
    "generale": [
        "Seigneur, r√©v√®le-moi le sens profond de ce r√™ve et conduis-moi dans ta volont√©. Amen.",
        "P√®re, √©claire mon esprit et affermis mon c≈ìur dans la foi chaque jour. Amen.",
        "Dieu vivant, parle-moi et dirige mes pas selon ta Parole √©ternelle. Amen.",
        "Seigneur, dans les √©preuves de la vie ou des r√™ves, sois mon rocher et ma gu√©rison. Amen.",
        "J√©sus, guide-moi par ton Esprit pour comprendre tes messages cach√©s. Amen.",
    ],
}

CONSEILS_SPIRITUELS: List[str] = [
    "M√©ditez ce r√™ve devant Dieu et notez ce qu'il met sur votre c≈ìur pour plus de clart√©.",
    "Priez sp√©cifiquement pour la partie du r√™ve qui vous a marqu√© ou troubl√©.",
    "Lisez un passage biblique reli√© aux symboles ou √©motions aper√ßus dans le r√™ve.",
    "Partagez ce r√™ve avec un mentor spirituel digne de confiance pour un discernement partag√©.",
    "Tenez un journal de r√™ves pour suivre l'√©volution des messages que Dieu vous envoie.",
    "Recherchez la paix: la voix de Dieu apporte toujours clart√© et douceur √† l'√¢me.",
    "Veillez √† ob√©ir aux petites impulsions de l'Esprit dans votre vie quotidienne.",
    "Examinez vos √©motions: elles peuvent r√©v√©ler des d√©sirs profonds ou des luttes int√©rieures.",
    "Demandez √† Dieu un signe de confirmation dans la Parole pour guider vos pas.",
    "Louez Dieu: la louange aligne le c≈ìur et dissipe la crainte ou le doute.",
    "Pratiquez le repos et le silence devant Dieu pour entendre Sa voix plus clairement.",
    "√âcartez ce qui trouble: simplifiez votre vie pour mieux discerner la volont√© divine.",
    "Interc√©dez pour une personne vue dans le r√™ve, si cela semble appropri√©.",
    "Recherchez l'unit√© et la r√©conciliation dans vos relations, si le r√™ve y fait allusion.",
    "Prenez un temps de je√ªne bref pour √©couter Dieu avec plus d'intensit√©.",
    "R√©examinez vos priorit√©s √† la lumi√®re du r√™ve et de la Parole de Dieu.",
    "Notez les couleurs, objets ou th√®mes r√©currents et cherchez leur sens biblique.",
    "Remerciez Dieu pour ce qu'Il a d√©j√† √©clair√© en vous √† travers ce r√™ve.",
    "Demandez sagesse et discernement chaque matin pour comprendre les messages divins.",
    "Soyez patient: certaines r√©v√©lations se d√©voilent avec le temps et la pri√®re.",
    "Confiez vos peurs de maladie ou de mort √† Dieu, en cherchant Sa paix.",
    "Cherchez la gu√©rison spirituelle et physique par la foi et la communaut√©.",
    "M√©ditez sur les promesses de vie √©ternelle pour surmonter les craintes.",
    "Ancrez votre c≈ìur dans l'esp√©rance de la r√©surrection et de la vie en Christ.",
]

INTRO_TEMPLATES = [
    "üåü INTERPR√âTATION BIBLIQUE DE VOTRE R√äVE üåü\n",
    "‚ú® Lecture spirituelle approfondie de votre r√™ve ‚ú®\n",
    "üîç Analyse biblique d√©taill√©e et discernement spirituel üîç\n",
    "üïäÔ∏è R√©v√©lation divine √† travers votre r√™ve üïäÔ∏è\n",
]

MESSAGE_SPIRITUEL_TEMPLATES = [
    "Le Seigneur parle souvent par les r√™ves, comme avec Joseph et Daniel. Recevez cette interpr√©tation avec un c≈ìur ouvert √† Sa paix.",
    "Dieu utilise les r√™ves pour attirer notre attention, nous guider, ou r√©v√©ler Ses desseins. Approchez ce message avec foi.",
    "Les r√™ves sont un langage de l'Esprit; √©coutez avec humilit√© pour d√©couvrir ce que Dieu veut vous enseigner.",
    "M√™me dans les r√™ves troublants, Dieu offre espoir, gu√©rison et direction. Confiez-vous √† Lui.",
    "Ce r√™ve peut √™tre une invitation divine √† approfondir votre relation avec Dieu et √† chercher Sa volont√©.",
]

CONCLUSION_TEMPLATES = [
    "Priez et m√©ditez: le Saint-Esprit confirmera et dirigera vos pas avec douceur et clart√©.",
    "Gardez ce r√™ve devant Dieu, cherchez Sa volont√©, et avancez dans Sa paix jour apr√®s jour.",
    "Que la paix de Christ garde votre c≈ìur et vous guide √† travers les messages de ce r√™ve.",
    "Dieu est votre gu√©risseur et votre refuge; confiez-Lui vos craintes et marchez dans Sa lumi√®re.",
    "Continuez √† chercher Dieu dans la pri√®re; Il r√©v√®le Ses v√©rit√©s au temps fix√©.",
]

SEPARATOR_CHOICES = ["‚îÄ", "‚Äî", "¬∑", "¬∑", "‚îÅ"]

# ------------------------------------------------------------
# Main Bot Class
# ------------------------------------------------------------

class DreamBot:
    def __init__(self, token: str, db_path: str = "dreambot.db"):
        """
        Initializes the Telegram bot with the provided token and database path.
        """
        try:
            self.bot = telebot.TeleBot(token, parse_mode='Markdown')
            self.db = sqlite3.connect(db_path, check_same_thread=False)
            self.selector = NonRepeatingSelector(self.db)
            self.user_states: Dict[int, str] = {}
            self._ensure_schema()
            self._setup_handlers()
        except Exception as e:
            print(f"Bot initialization error: {e}")
            raise

    def _ensure_schema(self) -> None:
        """
        Creates the dreams table and index if they don't exist.
        """
        try:
            cur = self.db.cursor()
            cur.execute("""
                CREATE TABLE IF NOT EXISTS dreams (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    user_id INTEGER NOT NULL,
                    dream_text TEXT NOT NULL,
                    interpretation_text TEXT NOT NULL,
                    created_at TEXT NOT NULL
                )
            """)
            cur.execute("CREATE INDEX IF NOT EXISTS idx_dreams_user ON dreams(user_id, created_at DESC)")
            self.db.commit()
        except sqlite3.Error as e:
            print(f"Database schema creation error: {e}")

    def _setup_handlers(self) -> None:
        """
        Sets up all Telegram command and message handlers.
        """
        @self.bot.message_handler(commands=['start'])
        def start_command(message):
            user_id = message.from_user.id
            username = message.from_user.first_name or "ami"
            welcome_text = (
                "üîÆ *Bienvenue dans le Bot d'Interpr√©tation Biblique des R√™ves* üîÆ\n\n"
                f"Bonjour {escape_md(username)} ! D√©crivez-moi votre r√™ve, m√™me le plus complexe, et je vous offrirai une interpr√©tation biblique d√©taill√©e, vari√©e et sans r√©p√©tition.\n\n"
                "*Commandes utiles:*\n"
                "/aide ‚Äî Guide pour une meilleure utilisation\n"
                "/versets ‚Äî Versets d'encouragement vari√©s\n"
                "/prieres ‚Äî Pri√®res adapt√©es et non r√©p√©titives\n"
                "/historique [page] ‚Äî Consultez votre historique de r√™ves\n\n"
                "Ou utilisez les boutons ci-dessous pour commencer."
            )
            keyboard = ReplyKeyboardMarkup(resize_keyboard=True)
            keyboard.add(KeyboardButton("üìù Interpr√©ter un r√™ve"))
            keyboard.add(KeyboardButton("üìñ Versets d'encouragement"))
            keyboard.add(KeyboardButton("üôè Pri√®res sp√©ciales"))
            keyboard.add(KeyboardButton("üìö Mon historique"))
            keyboard.add(KeyboardButton("‚ÑπÔ∏è Aide"))
            self.bot.reply_to(message, welcome_text, reply_markup=keyboard)
            self.user_states[user_id] = "ready"

        @self.bot.message_handler(commands=['aide'])
        def help_command(message):
            help_text = (
                "*üìö GUIDE D'UTILISATION* üìö\n\n"
                "‚Ä¢ Envoyez une description d√©taill√©e de votre r√™ve (ex: 'J'ai r√™v√© que...')\n"
                "‚Ä¢ Le bot analyse les symboles, √©motions, et le contexte pour une interpr√©tation biblique approfondie\n"
                "‚Ä¢ Les r√©ponses sont vari√©es gr√¢ce √† un syst√®me anti-r√©p√©tition\n"
                "‚Ä¢ Consultez votre historique avec /historique [page]\n\n"
                "*Conseils:*\n"
                "‚Äî D√©crivez les √©motions, couleurs, objets, personnes, lieux, ou actions\n"
                "‚Äî Plus de d√©tails = interpr√©tation plus riche et pr√©cise\n"
                "‚Äî Si ce n'est pas un r√™ve, pr√©cisez-le ou consultez un pasteur\n"
            )
            self.bot.reply_to(message, help_text)

        @self.bot.message_handler(commands=['versets'])
        def versets_command(message):
            user_id = message.from_user.id
            verset = self.selector.select_one(
                user_id,
                "verset:encouragement",
                VERSETS_ENCOURAGEMENT,
                key_fn=lambda v: v["key"]
            )
            sep = random.choice(SEPARATOR_CHOICES) * 40
            text = (
                "*üìñ VERSET D'ENCOURAGEMENT* üìñ\n\n"
                f"*{escape_md(verset['verset'])}*\n"
                f"_{escape_md(verset['texte'])}_\n\n"
                f"{sep}\n"
                "Prenez un moment pour m√©diter ce verset et prier pour sa r√©v√©lation dans votre vie."
            )
            self.bot.reply_to(message, text)

        @self.bot.message_handler(commands=['prieres'])
        def prieres_command(message):
            user_id = message.from_user.id
            category = random.choice(list(PRIERE_PAR_EMOTION.keys()))
            options = PRIERE_PAR_EMOTION[category]
            priere = self.selector.select_one(
                user_id,
                f"priere:{category}",
                options,
                key_fn=lambda p: p
            )
            self.bot.reply_to(message, f"*üôè Pri√®re pour vous:*\n{escape_md(priere)}")

        @self.bot.message_handler(commands=['historique'])
        def history_command(message):
            user_id = message.from_user.id
            page = 1
            parts = message.text.strip().split()
            if len(parts) >= 2 and parts[1].isdigit():
                page = max(1, int(parts[1]))
            page_size = 10
            offset = (page - 1) * page_size

            try:
                cur = self.db.cursor()
                cur.execute("""
                    SELECT dream_text, interpretation_text, created_at
                    FROM dreams
                    WHERE user_id=?
                    ORDER BY id DESC
                    LIMIT ? OFFSET ?
                """, (user_id, page_size, offset))
                rows = cur.fetchall()
            except sqlite3.Error as e:
                self.bot.reply_to(message, f"Erreur lors de la r√©cup√©ration de l'historique: {e}")
                return

            if not rows:
                self.bot.reply_to(message, "üìö Aucun r√™ve enregistr√© √† cette page. Envoyez un r√™ve pour commencer.")
                return

            sep = random.choice(SEPARATOR_CHOICES) * 40
            lines = ["*üìö HISTORIQUE DE VOS R√äVES* üìö\n"]
            for idx, (dream_text, _interp, created_at) in enumerate(rows, start=1 + offset):
                preview = dream_text[:120] + ("‚Ä¶" if len(dream_text) > 120 else "")
                lines.append(f"*üîÆ #{idx}* ‚Äî {escape_md(created_at)}\n_{escape_md(preview)}_\n{sep}")

            lines.append(f"\nUtilisez `/historique {page+1}` pour la page suivante.")
            self.bot.reply_to(message, "\n\n".join(lines))

        @self.bot.message_handler(func=lambda m: m.text == "üìù Interpr√©ter un r√™ve")
        def interpret_dream_button(message):
            self.user_states[message.from_user.id] = "waiting_for_dream"
            self.bot.reply_to(
                message,
                "üåô D√©crivez-moi votre r√™ve en d√©tail.\n"
                "*Exemple:* 'J'ai r√™v√© que je volais au-dessus d'une mer agit√©e, puis je suis entr√© dans une maison lumineuse...'\n"
                "Incluez √©motions, lieux, personnes, ou objets pour une interpr√©tation plus pr√©cise."
            )

        @self.bot.message_handler(func=lambda m: m.text == "üìñ Versets d'encouragement")
        def versets_button(message):
            versets_command(message)

        @self.bot.message_handler(func=lambda m: m.text == "üôè Pri√®res sp√©ciales")
        def prieres_button(message):
            prieres_command(message)

        @self.bot.message_handler(func=lambda m: m.text == "üìö Mon historique")
        def history_button(message):
            history_command(message)

        @self.bot.message_handler(func=lambda m: m.text == "‚ÑπÔ∏è Aide")
        def help_button(message):
            help_command(message)

        @self.bot.message_handler(func=lambda m: True, content_types=['text'])
        def handle_any_text(message):
            user_id = message.from_user.id
            state = self.user_states.get(user_id, "ready")
            if state == "waiting_for_dream" or True:
                self._process_dream(message)
                self.user_states[user_id] = "ready"

    # --------------------------------------------------------
    # Core: Dream Processing - Enhanced for universal and detailed interpretation
    # --------------------------------------------------------

    def _detect_emotion(self, text: str) -> Optional[str]:
        """
        Detects emotions in the dream text based on keywords.
        """
        low = text.lower()
        emotions = {
            "peur": ["peur", "effray", "terrifi", "angoiss", "crainte", "mourrir", "mort", "cancer", "tombe", "d√©c√®s"],
            "inquietude": ["inqui", "souci", "stress", "anxieu", "tension", "nerveux"],
            "tristesse": ["triste", "pleur", "d√©sespoir", "deprim", "chagrin", "souffrance"],
            "colere": ["col√®re", "f√¢ch", "rage", "irrit", "agac√©", "frustr√©"],
            "doute": ["doute", "incert", "confus", "perdu", "h√©sit", "ind√©cis"],
            "espoir": ["espoir", "joie", "lumi√®re", "gu√©ri", "sauv√©", "lib√©r√©"],
            "confusion": ["confus", "perdu", "flou", "√©trange", "bizarre", "incompr√©hensible"],
        }
        for emo, keys in emotions.items():
            if any(k in low for k in keys):
                return emo
        return None

    def _tokenize_words(self, text: str) -> List[str]:
        """
        Tokenizes text into words, handling accented characters and common typos.
        """
        text = text.lower().replace("mourrir", "mourir").replace("bientot", "bient√¥t")
        return re.findall(r"[A-Za-z√Ä-√ñ√ò-√∂√∏-√ø'-]+", text)

    def _find_symbols(self, text: str) -> List[str]:
        """
        Identifies symbols in the dream text by matching against SYMBOLS dictionary.
        """
        words = set(self._tokenize_words(text))
        found: List[str] = []
        for sym, data in SYMBOLS.items():
            keys = {sym.lower()}
            keys.update({k.lower() for k in data.get("synonymes", [])})
            if any(k in words for k in keys) or any(k in text.lower() for k in keys):
                found.append(sym)
        return list(set(found))  # Remove duplicates

    def _select_symbol_interpretations(self, user_id: int, symbols: List[str]) -> List[Tuple[str, Dict[str, str]]]:
        """
        Selects up to 5 distinct symbols and their non-recent interpretations.
        """
        if not symbols:
            return []
        max_symbols = min(5, len(symbols))
        k = random.randint(2, max_symbols) if len(symbols) > 1 else len(symbols)
        random.shuffle(symbols)
        picked_symbols = symbols[:k]

        results: List[Tuple[str, Dict[str, str]]] = []
        for sym in picked_symbols:
            interp_list = SYMBOLS[sym]["interpretations"]
            choice = self.selector.select_one(
                user_id,
                f"symbole:{sym}",
                interp_list,
                key_fn=lambda d: f"{d['verset']}|{d['interpretation'][:30]}"
            )
            results.append((sym, choice))
        return results

    def _select_encouragement_verse(self, user_id: int, emotion: Optional[str] = None) -> Dict[str, str]:
        """
        Selects a non-recent encouragement verse, prioritizing those matching the detected emotion.
        """
        if emotion in ["peur", "tristesse"]:
            priority_verses = [
                v for v in VERSETS_ENCOURAGEMENT
                if v["key"] in ["Ps103:2-3", "Jn11:25", "Ps118:17", "Ps30:2-3", "Isa53:5"]
            ]
            if priority_verses:
                return self.selector.select_one(
                    user_id,
                    "verset:encouragement",
                    priority_verses,
                    key_fn=lambda v: v["key"]
                )
        return self.selector.select_one(
            user_id,
            "verset:encouragement",
            VERSETS_ENCOURAGEMENT,
            key_fn=lambda v: v["key"]
        )

    def _select_conseils(self, user_id: int, emotion: Optional[str] = None) -> List[str]:
        """
        Selects 4 to 8 non-recent spiritual advice items, prioritizing those matching the emotion.
        """
        k = random.randint(4, 8)
        if emotion in ["peur", "tristesse"]:
            priority_conseils = [
                c for c in CONSEILS_SPIRITUELS
                if any(kw in c.lower() for kw in ["peur", "maladie", "mort", "gu√©rison", "esp√©rance"])
            ]
            if priority_conseils:
                return self.selector.select_many(
                    user_id,
                    "conseil",
                    priority_conseils,
                    key_fn=lambda c: c,
                    k=min(k, len(priority_conseils))
                )
        return self.selector.select_many(
            user_id,
            "conseil",
            CONSEILS_SPIRITUELS,
            key_fn=lambda c: c,
            k=k
        )

    def _select_templates(self, user_id: int) -> Tuple[str, str, str, str]:
        """
        Selects non-recent intro, message, conclusion templates, and a random separator.
        """
        intro = self.selector.select_one(user_id, "tpl:intro", INTRO_TEMPLATES, key_fn=lambda s: s)
        msg = self.selector.select_one(user_id, "tpl:message", MESSAGE_SPIRITUEL_TEMPLATES, key_fn=lambda s: s)
        conc = self.selector.select_one(user_id, "tpl:conclusion", CONCLUSION_TEMPLATES, key_fn=lambda s: s)
        sep = random.choice(SEPARATOR_CHOICES) * 40
        return intro, msg, conc, sep

    def _select_priere_personnalisee(self, user_id: int, text: str) -> str:
        """
        Selects a non-recent prayer based on detected emotion or general category.
        """
        emo = self._detect_emotion(text) or "generale"
        options = PRIERE_PAR_EMOTION[emo]
        return self.selector.select_one(user_id, f"priere:{emo}", options, key_fn=lambda p: p)

    def _generate_fallback_interpretation(self, text: str, emotion: Optional[str]) -> str:
        """
        Generates a detailed interpretation when no specific symbols are detected.
        """
        words_count = len(self._tokenize_words(text))
        base = "Bien que ce r√™ve ne contienne pas de symboles clairement identifiables, il semble porter un message spirituel important. "
        if emotion == "peur":
            base += "Il peut refl√©ter des craintes profondes, peut-√™tre li√©es √† des incertitudes ou des √©preuves comme la maladie ou la mort. Dieu vous invite √† vous appuyer sur Sa force et Sa promesse de vie √©ternelle. M√©ditez sur Sa pr√©sence qui surpasse toute peur."
        elif emotion == "tristesse":
            base += "Il semble exprimer une douleur ou une perte int√©rieure. Dieu est proche des c≈ìurs bris√©s et promet de restaurer votre joie par Son amour. Cherchez Sa consolation dans la pri√®re."
        elif emotion == "espoir":
            base += "Ce r√™ve pourrait refl√©ter un d√©sir d'esp√©rance ou de renouveau. Dieu vous appelle √† fixer vos yeux sur Ses promesses et √† marcher dans Sa lumi√®re."
        elif emotion == "confusion":
            base += "Il peut indiquer un besoin de clart√© ou de direction. Dieu est un Dieu d'ordre; cherchez Sa sagesse √† travers la pri√®re et Sa Parole."
        else:
            base += "Ce r√™ve pourrait refl√©ter un moment de r√©flexion ou une invitation √† approfondir votre relation avec Dieu. Consid√©rez les √©motions et le contexte pour discerner Son message."

        base += f" Le Seigneur utilise souvent les r√™ves pour r√©v√©ler des v√©rit√©s cach√©es ou pour pr√©parer votre c≈ìur √† Ses plans. Prenez du temps pour m√©diter et prier, en demandant la guidance de l'Esprit Saint."
        return base

    def _build_detailed_interpretation(self, symbol_items: List[Tuple[str, Dict[str, str]]], text: str, emotion: Optional[str]) -> str:
        """
        Builds a detailed narrative interpretation by combining symbols, context, and emotion.
        """
        words_count = len(self._tokenize_words(text))
        if not symbol_items:
            return self._generate_fallback_interpretation(text, emotion)

        detail = "Ce r√™ve semble tisser une histoire spirituelle riche, o√π plusieurs √©l√©ments s'entrelacent pour r√©v√©ler un message divin : "
        for i, (sym, info) in enumerate(symbol_items):
            detail += f"le symbole *{sym}* ({info['interpretation'].lower()[:-1]})"
            if i < len(symbol_items) - 2:
                detail += ", "
            elif i == len(symbol_items) - 2:
                detail += " et "
            else:
                detail += ". "

        detail += "\n\nDans son ensemble, ce r√™ve pourrait indiquer une p√©riode de transition, de purification, ou de confrontation avec des d√©fis int√©rieurs ou ext√©rieurs. "
        if emotion == "peur":
            detail += "Face √† la peur ou √† l'incertitude, comme peut-√™tre une maladie ou une fin, Dieu vous rappelle qu'Il est votre refuge et votre force. Il vous invite √† Lui confier vos craintes et √† marcher dans Sa paix."
        elif emotion == "tristesse":
            detail += "Dans la tristesse ou le deuil, Dieu se tient pr√®s de vous, pr√™t √† gu√©rir votre c≈ìur bris√© et √† vous envelopper de Son amour consolateur."
        elif emotion == "espoir":
            detail += "Ce r√™ve refl√®te un √©lan d'esp√©rance, une invitation √† fixer vos yeux sur les promesses √©ternelles de Dieu et √† avancer avec confiance."
        elif emotion == "confusion":
            detail += "Face √† la confusion, ce r√™ve vous appelle √† chercher la clart√© divine √† travers la pri√®re et la m√©ditation de la Parole."
        else:
            detail += "Ce r√™ve semble vous appeler √† un renouveau spirituel, √† une √©coute attentive de la voix de Dieu, et √† un alignement avec Sa volont√©."

        detail += "\n\nLe Seigneur utilise ces images pour parler √† votre c≈ìur, vous pr√©parant peut-√™tre √† une nouvelle saison, une gu√©rison, ou une r√©v√©lation de Sa gloire. Prenez du temps pour prier et m√©diter sur ces symboles, en demandant √† l'Esprit Saint de vous guider vers une compr√©hension plus profonde."
        return detail

    def _build_interpretation(self, user_id: int, dream_text: str) -> str:
        """
        Builds a formatted, detailed interpretation of the dream with symbols, context, verses, prayers, and advice.
        """
        intro, message_spirituel, conclusion, sep = self._select_templates(user_id)
        symbols_found = self._find_symbols(dream_text)
        symbol_items = self._select_symbol_interpretations(user_id, symbols_found)
        emotion = self._detect_emotion(dream_text)

        lines: List[str] = []
        lines.append(intro)
        lines.append(f"üìÖ *Analyse:* {escape_md(datetime.now().strftime('%d/%m/%Y %H:%M'))}\n")
        lines.append(sep)

        # Summary
        lines.append("*üìñ R√©sum√© du r√™ve:*\n")
        summary = dream_text.strip()
        if len(summary) > 350:
            summary = summary[:350] + "‚Ä¶"
        lines.append(f"_{escape_md(summary)}_\n")
        lines.append(sep)

        # Spiritual Message
        lines.append("*üåô Message spirituel:*\n")
        lines.append(f"{escape_md(message_spirituel)}\n")
        lines.append(sep)

        # Symbols - Detailed listing
        if symbol_items:
            lines.append("*üîç Symboles bibliques identifi√©s:*\n")
            for sym, info in symbol_items:
                lines.append(f"‚Ä¢ *{escape_md(sym.upper())}*\n")
                lines.append(f"  *Signification:* {escape_md(info['interpretation'])}\n")
                lines.append(f"  *üìñ Verset:* {escape_md(info['verset'])}\n")
                lines.append(f"  *üôè Pri√®re:* {escape_md(info['priere'])}\n")
            lines.append(sep)
        else:
            lines.append("*üîç Symboles bibliques:*\n")
            lines.append("Aucun symbole sp√©cifique n'a √©t√© clairement d√©tect√©. Cependant, chaque r√™ve peut porter un message divin. Consid√©rez les √©motions, le contexte, et les d√©tails pour discerner la voix de Dieu.\n")
            lines.append(sep)

        # Contextual Analysis - New detailed section
        lines.append("*üí≠ Analyse contextuelle:*\n")
        detailed_interp = self._build_detailed_interpretation(symbol_items, dream_text, emotion)
        lines.append(f"{escape_md(detailed_interp)}\n")
        lines.append(sep)

        # General Interpretation - Enhanced for depth
        words_count = len(self._tokenize_words(dream_text))
        general_pool = [
            "Ce r√™ve vous invite √† approfondir votre relation avec Dieu, en cherchant Sa guidance √† travers la pri√®re et Sa Parole, surtout face aux d√©fis actuels.",
            "Il semble marquer une saison de transformation int√©rieure, o√π l'Esprit de Dieu travaille pour vous renouveler et vous fortifier.",
            "Ce r√™ve peut refl√©ter des luttes int√©rieures ou ext√©rieures, mais J√©sus promet la paix et la victoire √† ceux qui se confient en Lui.",
            "Votre √¢me aspire √† une croissance spirituelle, √† une connexion plus profonde avec Dieu, et √† une foi renouvel√©e.",
            "Ce r√™ve pourrait signaler un besoin de gu√©rison √©motionnelle ou spirituelle, avec un appel √† chercher la pr√©sence consolatrice de Dieu.",
            "Dieu vous parle √† travers ce r√™ve pour r√©aligner vos priorit√©s, vous pr√©parant √† une nouvelle √©tape dans Sa volont√©.",
            "Ce r√™ve est une invitation √† √©couter la voix douce de l'Esprit, qui apporte clart√©, paix, et direction dans les moments d'incertitude.",
            "Il peut refl√©ter une lutte ou une √©preuve, mais Dieu vous assure de Sa pr√©sence et de Son plan r√©dempteur pour votre vie.",
        ]
        index = min(words_count // 8, len(general_pool) - 1)  # Adjusted for sensitivity
        lines.append("*üåü Interpr√©tation g√©n√©rale:*\n")
        lines.append(f"{escape_md(general_pool[index])}\n")
        lines.append(sep)

        # Encouragement Verse
        verset = self._select_encouragement_verse(user_id, emotion)
        lines.append("*üìñ Verset d'encouragement:*\n")
        lines.append(f"*{escape_md(verset['verset'])}*\n_{escape_md(verset['texte'])}_\n")
        lines.append(sep)

        # Personalized Prayer
        priere = self._select_priere_personnalisee(user_id, dream_text)
        lines.append("*üôè Pri√®re personnalis√©e:*\n")
        lines.append(f"{escape_md(priere)}\n")
        lines.append(sep)

        # Spiritual Advice
        conseils = self._select_conseils(user_id, emotion)
        lines.append("*üí° Conseils spirituels:*\n")
        for c in conseils:
            lines.append(f"‚Ä¢ {escape_md(c)}")
        lines.append(sep)

        # Conclusion
        lines.append("*üïäÔ∏è Conclusion:*\n")
        lines.append(f"{escape_md(conclusion)}\n")
        lines.append("üîÆ Utilisez /historique pour revoir vos r√™ves ou envoyez un nouveau r√™ve pour une autre analyse.\n")
        return "\n".join(lines)

    def _save_dream(self, user_id: int, dream_text: str, interpretation: str) -> None:
        """
        Saves the dream and its interpretation to the database.
        """
        try:
            cur = self.db.cursor()
            cur.execute(
                "INSERT INTO dreams (user_id, dream_text, interpretation_text, created_at) VALUES (?, ?, ?, ?)",
                (user_id, dream_text, interpretation, now_str())
            )
            self.db.commit()
        except sqlite3.Error as e:
            print(f"Error saving dream: {e}")

    def _process_dream(self, message) -> None:
        """
        Processes a user's dream, generates an interpretation, and saves it.
        Checks if it seems like a dream; otherwise, suggests rephrasing.
        """
        user_id = message.from_user.id
        text = message.text.strip()
        if len(text) < 10:
            self.bot.reply_to(
                message,
                "‚ö†Ô∏è D√©crivez votre r√™ve plus en d√©tail (au moins quelques phrases) pour une interpr√©tation pr√©cise."
            )
            return

        # Check if it's a dream description
        lower_text = text.lower()
        dream_keywords = ["r√™ve", "r√™vais", "r√™v√©", "songe", "vision", "nuit", "dormir"]
        if not any(kw in lower_text for kw in dream_keywords):
            self.bot.reply_to(
                message,
                "‚ö†Ô∏è Cela ne semble pas √™tre une description de r√™ve. Veuillez pr√©ciser si c'est un r√™ve (ex: 'J'ai r√™v√© que...') ou reformulez. Si c'est une pr√©occupation personnelle, priez et consultez un pasteur ou un mentor spirituel."
            )
            return

        processing = self.bot.reply_to(
            message,
            "üîÆ Analyse en cours‚Ä¶ ‚è≥ Merci de patienter quelques instants."
        )
        time.sleep(random.uniform(0.8, 2.0))

        interpretation = self._build_interpretation(user_id, text)

        try:
            self.bot.delete_message(message.chat.id, processing.message_id)
        except Exception:
            pass

        self.bot.reply_to(message, interpretation)
        self._save_dream(user_id, text, interpretation)

    def run(self) -> None:
        """
        Starts the bot's polling loop.
        """
        print("üîÆ Bot d√©marr√©. Appuyez Ctrl+C pour arr√™ter.")
        try:
            self.bot.polling(none_stop=True, interval=0, timeout=20)
        except Exception as e:
            print(f"Erreur de polling: {e}")
            time.sleep(5)
            self.run()

# ------------------------------------------------------------
# Entry Point
# ------------------------------------------------------------

def main():
    """
    Main function to initialize and run the bot with the provided token.
    """
    token = "7506566781:AAGnBOfXpMgil4ZafjWjKzMlF6j8VG2mZxk"
    if not token:
        print("‚ùå TELEGRAM_TOKEN manquant.")
        return
    try:
        bot = DreamBot(token)
        bot.run()
    except Exception as e:
        print(f"Erreur lors du d√©marrage du bot: {e}")

if __name__ == "__main__":
    main()
